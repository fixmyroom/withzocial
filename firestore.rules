rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ Users collection (customers, workers, stores)
    match /users/{userId} {
      allow read: if true; // everyone can view profiles
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == userId;

      // ✅ Admin override
      allow write: if request.auth.token.email == "pratikaryal1986@gmail.com";
    }

    // ✅ Requests collection
    match /requests/{requestId} {
      // Customers can create requests
      allow create: if request.auth != null;

      // Workers can read requests, but we'll hide phone number in client-side
      allow read: if request.auth != null;

      // Only the request creator or admin can delete
      allow delete: if request.auth != null &&
        (request.resource.data.customerId == request.auth.uid ||
         request.auth.token.email == "pratikaryal1986@gmail.com");

      // Admin full access
      allow write: if request.auth.token.email == "pratikaryal1986@gmail.com";
    }

    // ✅ Stores collection
    match /stores/{storeId} {
      allow read: if true; // visible to customers
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == storeId;

      // Admin override
      allow write: if request.auth.token.email == "pratikaryal1986@gmail.com";
    }

    // ✅ Default deny for everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
