<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixMyRoom - Store Dashboard</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <img src="img/logo.png" alt="FixMyRoom" class="logo">
    <h1>ğŸ¬ Store Dashboard</h1>
    <button class="btn btn-danger" onclick="logout()">ğŸšª Logout</button>
  </header>

  <main class="container">
    <!-- ğŸ“‹ Store Profile -->
    <section class="card">
      <h2>ğŸ‘¤ Store Profile</h2>
      <input type="text" id="storeName" placeholder="ğŸª Store Name" />
      <input type="text" id="storePhone" placeholder="ğŸ“ Phone Number" />
      <textarea id="storeDesc" placeholder="ğŸ“ Short Description"></textarea>
      <button id="saveStore" class="btn btn-primary">ğŸ’¾ Save Profile</button>
    </section>

    <!-- ğŸ›’ Product Catalog -->
    <section class="card">
      <h2>ğŸ›’ Product Catalog</h2>
      <input type="text" id="productName" placeholder="ğŸ“¦ Product Name" />
      <input type="number" id="productPrice" placeholder="ğŸ’° Price (Rs.)" />
      <input type="file" id="productPhoto" accept="image/*" />
      <button id="addProduct" class="btn btn-dark">â• Add Product</button>

      <h3 style="margin-top:15px;">ğŸ“‚ My Products</h3>
      <div id="catalogGallery" style="display:flex;flex-wrap:wrap;gap:15px;margin-top:10px;"></div>
    </section>
  </main>

  <script src="js/firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const dbRef = db.collection("stores");
    const storage = firebase.storage();

    // âœ… Redirect if not logged in
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadStore(user.uid);
        loadProducts(user.uid);
      }
    });

    // âœ… Save store profile
    document.getElementById("saveStore").onclick = () => {
      const user = auth.currentUser;
      if (!user) return;

      const data = {
        name: document.getElementById("storeName").value,
        phone: document.getElementById("storePhone").value,
        desc: document.getElementById("storeDesc").value,
        updatedAt: Date.now()
      };

      dbRef.doc(user.uid).set(data, { merge: true })
        .then(() => alert("âœ… Store profile saved"))
        .catch(err => alert("âŒ " + err.message));
    };

    // âœ… Add product
    document.getElementById("addProduct").onclick = () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = document.getElementById("productName").value.trim();
      const price = document.getElementById("productPrice").value.trim();
      const file = document.getElementById("productPhoto").files[0];

      if (!name || !price || !file) {
        alert("âŒ Please fill all product fields!");
        return;
      }

      const storageRef = storage.ref(`products/${user.uid}/${Date.now()}_${file.name}`);
      storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          return dbRef.doc(user.uid).collection("products").add({
            name, price, photo: url,
            createdAt: Date.now()
          });
        })
        .then(() => {
          alert("âœ… Product added!");
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          document.getElementById("productPhoto").value = "";
          loadProducts(user.uid);
        })
        .catch(err => alert("âŒ " + err.message));
    };

    // âœ… Load store profile
    function loadStore(uid) {
      dbRef.doc(uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("storeName").value = data.name || "";
          document.getElementById("storePhone").value = data.phone || "";
          document.getElementById("storeDesc").value = data.desc || "";
        }
      });
    }

    // âœ… Load products
    function loadProducts(uid) {
      const gallery = document.getElementById("catalogGallery");
      gallery.innerHTML = "";

      dbRef.doc(uid).collection("products")
        .orderBy("createdAt", "desc")
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const p = doc.data();
            const div = document.createElement("div");
            div.className = "card";
            div.style = "width:140px;text-align:center;";
            div.innerHTML = `
              <img src="${p.photo}" style="width:100%;height:100px;object-fit:cover;border-radius:6px;margin-bottom:6px;" />
              <p><b>${p.name}</b><br>Rs. ${p.price}</p>
            `;
            gallery.appendChild(div);
          });
        });
    }

    // âœ… Logout
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }
  </script>
</body>
</html>
