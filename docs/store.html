<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixMyRoom - Store Dashboard</title>
  <link rel="stylesheet" href="css/styles.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: white;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { height: 40px; }
    h1 { margin: 0; font-size: 20px; }
    main { padding: 20px; }
    .card {
      background: #111;
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    input, textarea {
      width: 95%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: none;
      background: #222;
      color: #fff;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background: #28a745;
      color: white;
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover { background: #218838; }
    .danger { background: #f44336; }
    .danger:hover { background: #d32f2f; }
    #catalogGallery {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    .product-card {
      background: #1a1a1a;
      border-radius: 10px;
      padding: 10px;
      width: 140px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .product-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 6px;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <img src="img/logo.png" alt="FixMyRoom" class="logo">
    <h1>üè¨ Store Dashboard</h1>
    <button onclick="logout()">üö™ Logout</button>
  </header>

  <main class="container">
    <!-- üìã Store Profile -->
    <section class="card">
      <h2>üë§ Store Profile</h2>
      <input type="text" id="storeName" placeholder="üè™ Store Name" />
      <input type="text" id="storePhone" placeholder="üìû Phone Number" />
      <textarea id="storeDesc" placeholder="üìù Short Description"></textarea>
      <button id="saveStore">üíæ Save Profile</button>
    </section>

    <!-- üõí Product Catalog -->
    <section class="card">
      <h2>üõí Product Catalog</h2>
      <input type="text" id="productName" placeholder="üì¶ Product Name" />
      <input type="number" id="productPrice" placeholder="üí∞ Price (Rs.)" />
      <input type="file" id="productPhoto" accept="image/*" />
      <button id="addProduct">‚ûï Add Product</button>

      <h3 style="margin-top:15px;">üìÇ My Products</h3>
      <div id="catalogGallery"></div>
    </section>
  </main>

  <script src="js/firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const storesRef = db.collection("stores");

    // ‚úÖ Redirect if not logged in
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadStore(user.uid);
        loadProducts(user.uid);
      }
    });

    // ‚úÖ Save store profile
    document.getElementById("saveStore").onclick = () => {
      const user = auth.currentUser;
      if (!user) return;

      const data = {
        name: document.getElementById("storeName").value,
        phone: document.getElementById("storePhone").value,
        desc: document.getElementById("storeDesc").value,
        updatedAt: Date.now()
      };

      storesRef.doc(user.uid).set(data, { merge: true })
        .then(() => alert("‚úÖ Store profile saved"))
        .catch(err => alert("‚ùå " + err.message));
    };

    // ‚úÖ Add product
    document.getElementById("addProduct").onclick = () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = document.getElementById("productName").value.trim();
      const price = document.getElementById("productPrice").value.trim();
      const file = document.getElementById("productPhoto").files[0];

      if (!name || !price || !file) {
        alert("‚ùå Please fill all product fields!");
        return;
      }

      const storageRef = storage.ref(`products/${user.uid}/${Date.now()}_${file.name}`);
      storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          return storesRef.doc(user.uid).collection("products").add({
            name, price, photo: url,
            createdAt: Date.now()
          });
        })
        .then(() => {
          alert("‚úÖ Product added!");
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          document.getElementById("productPhoto").value = "";
          loadProducts(user.uid);
        })
        .catch(err => alert("‚ùå " + err.message));
    };

    // ‚úÖ Load store profile
    function loadStore(uid) {
      storesRef.doc(uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("storeName").value = data.name || "";
          document.getElementById("storePhone").value = data.phone || "";
          document.getElementById("storeDesc").value = data.desc || "";
        }
      });
    }

    // ‚úÖ Load products
    function loadProducts(uid) {
      const gallery = document.getElementById("catalogGallery");
      gallery.innerHTML = "";

      storesRef.doc(uid).collection("products")
        .orderBy("createdAt", "desc")
        .get()
        .then(snapshot => {
          snapshot.forEach(docSnap => {
            const p = docSnap.data();
            const div = document.createElement("div");
            div.className = "product-card";
            div.innerHTML = `
              <img src="${p.photo}" alt="${p.name}" />
              <p><b>${p.name}</b><br>Rs. ${p.price}</p>
              <button class="danger" onclick="deleteProduct('${uid}','${docSnap.id}')">üóë Delete</button>
            `;
            gallery.appendChild(div);
          });
        });
    }

    // ‚úÖ Delete product
    function deleteProduct(uid, productId) {
      if (!confirm("Are you sure you want to delete this product?")) return;
      storesRef.doc(uid).collection("products").doc(productId).delete()
        .then(() => {
          alert("üóë Product deleted!");
          loadProducts(uid);
        })
        .catch(err => alert("‚ùå " + err.message));
    }

    // ‚úÖ Logout
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }
  </script>
</body>
</html>
