<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FixMyRoom - Worker Dashboard</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="img/logo.png" type="image/png" />
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: #111;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      height: 40px;
    }

    h1 {
      font-size: 20px;
      margin: 0;
      flex: 1;
      text-align: center;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-primary {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .container {
      padding: 20px;
    }

    .card {
      background: #111;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      border: none;
      background: #222;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #333;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <img src="img/logo.png" alt="FixMyRoom" class="logo" onerror="this.src='img/default-user.png';"/>
    <h1>ğŸ›  Worker Dashboard</h1>
    <button class="btn btn-danger" id="logoutBtn">ğŸšª Logout</button>
  </header>

  <main class="container">
    <section class="card">
      <h2>ğŸ‘¤ My Profile</h2>
      <input type="text" id="workerName" placeholder="Your Name" />
      <input type="text" id="workerPhone" placeholder="Your Phone" inputmode="tel" />
      <input type="number" id="workerPrice" placeholder="ğŸ’° Price per service" inputmode="numeric" />
      <button id="saveProfile" class="btn btn-primary">ğŸ’¾ Save Profile</button>
    </section>

    <section class="card">
      <h2>ğŸ“ My Location</h2>
      <p>Location updates automatically if GPS is enabled âœ…</p>
    </section>

    <section class="card">
      <h2>ğŸ“© Incoming Requests</h2>
      <table id="requestsTable">
        <thead>
          <tr>
            <th>Details</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Firebase compat version -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>

  <!-- Main Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const auth = firebase.auth();
      const db = firebase.firestore();

      const saveBtn = document.getElementById("saveProfile");
      const logoutBtn = document.getElementById("logoutBtn");

      auth.onAuthStateChanged(async user => {
        if (!user) {
          window.location.href = "login.html";
        } else {
          await loadProfile(user.uid);
          listenRequests();
          startLocationTracking(user.uid);
        }
      });

      saveBtn.addEventListener("click", async () => {
        const user = auth.currentUser;
        if (!user) return;

        const data = {
          name: document.getElementById("workerName").value.trim(),
          phone: document.getElementById("workerPhone").value.trim(),
          price: parseFloat(document.getElementById("workerPrice").value.trim()) || 0,
          updatedAt: Date.now()
        };

        try {
          await db.collection("users").doc(user.uid).set(data, { merge: true });
          alert("âœ… Profile saved");
        } catch (err) {
          alert("âŒ " + err.message);
        }
      });

      logoutBtn.addEventListener("click", () => {
        auth.signOut().then(() => window.location.href = "login.html");
      });

      async function loadProfile(uid) {
        try {
          const docSnap = await db.collection("users").doc(uid).get();
          if (docSnap.exists) {
            const data = docSnap.data();
            document.getElementById("workerName").value = data.name || "";
            document.getElementById("workerPhone").value = data.phone || "";
            document.getElementById("workerPrice").value = data.price || "";
          }
        } catch (err) {
          console.error("âŒ Failed to load profile:", err.message);
        }
      }

      function startLocationTracking(uid) {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            try {
              await db.collection("users").doc(uid).set({
                location: { lat, lng, updated: Date.now() }
              }, { merge: true });
            } catch (err) {
              console.error("âŒ Location update failed:", err.message);
            }
          }, err => {
            console.warn("âš ï¸ Geolocation denied or failed", err.message);
          }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        }
      }

      function listenRequests() {
        db.collection("requests").orderBy("createdAt", "desc")
          .onSnapshot(snapshot => {
            const table = document.querySelector("#requestsTable tbody");
            table.innerHTML = "";

            if (snapshot.empty) {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td colspan="2">No requests found</td>`;
              table.appendChild(tr);
            }

            snapshot.forEach(doc => {
              const r = doc.data();
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${r.details || "No details"}</td>
                <td>${r.createdAt ? new Date(r.createdAt).toLocaleString() : ""}</td>
              `;
              table.appendChild(tr);
            });
          }, err => {
            console.error("âŒ Error loading requests:", err.message);
          });
      }

      // Service worker registration
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(() => console.log("âœ… Service Worker registered"))
          .catch(e => console.error("âŒ SW error", e));
      }
    });
  </script>
</body>
</html>
